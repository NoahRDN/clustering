services:
  # ----------------------------
  # ðŸ”¹ HAProxy pour les serveurs Web
  # ----------------------------
  haproxy-web:
    image: haproxy:2.9
    container_name: haproxy-web
    ports:
      - "8080:8080"
      - "8404:8404"
    volumes:
      - ./haproxy-web/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
      - ./haproxy-web/runtime:/var/run/haproxy
      - ./haproxy-web/runtime:/haproxy-runtime
      - ./haproxy-web/haproxy-entrypoint.sh:/docker-entrypoint-custom.sh:ro
    depends_on:
      - web1
      - web2
    networks:
      - public_net
      - private_net
    command: ["/bin/bash", "/docker-entrypoint-custom.sh"]

  # ----------------------------
  # ðŸ”¹ HAProxy pour la base de donnÃ©es
  # ----------------------------
  haproxy-db:
    image: haproxy:2.9
    container_name: haproxy-db
    ports:
      - "3307:3307"      # HAProxy Ã©coute pour MySQL
      - "8405:8405"      # page de stats DB
    volumes:
      - ./haproxy-db/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
      - ./haproxy-db/runtime:/var/run/haproxy
      - ./haproxy-db/haproxy-entrypoint.sh:/docker-entrypoint-custom.sh:ro
      - ./haproxy-db/runtime:/haproxy-db-runtime
    depends_on:
      - mysql1
      - mysql2
    networks:
      - private_net
    command: ["/bin/bash", "/docker-entrypoint-custom.sh"]

  # ----------------------------
  # ðŸ”¹ Serveurs web (PHP + Apache)
  # ----------------------------
  web1:
    image: php:8.2-apache
    container_name: web1
    volumes:
      - ./web/web1:/var/www/html
      - ./web/shared:/var/www/shared
    depends_on:
      - haproxy-db
    networks:
      - private_net
    command: >
      bash -c "docker-php-ext-install pdo pdo_mysql && apache2-foreground"

  web2:
    image: php:8.2-apache
    container_name: web2
    volumes:
      - ./web/web2:/var/www/html
      - ./web/shared:/var/www/shared
    depends_on:
      - haproxy-db
    networks:
      - private_net
    command: >
      bash -c "docker-php-ext-install pdo pdo_mysql && apache2-foreground"

  web-dashboard:
    image: php:8.2-apache
    container_name: web-dashboard
    ports:
      - "8090:80"
    volumes:
      - ./web/web-dashboard:/var/www/html
      - ./haproxy-web:/data/haproxy-web
      - ./haproxy-db:/data/haproxy-db
      - ./haproxy-web/runtime:/haproxy-runtime
      - ./haproxy-db/runtime:/haproxy-db-runtime
    networks:
      - private_net
      - public_net
    command: >
      bash -c "docker-php-ext-install pdo pdo_mysql && apache2-foreground"

  web3:
    image: php:8.2-apache
    container_name: web3
    volumes:
      - ./web/web3:/var/www/html
      - ./web/shared:/var/www/shared
    depends_on:
      - haproxy-db
    networks:
      - private_net
    command: >
      bash -c "docker-php-ext-install pdo pdo_mysql && apache2-foreground"

  # ----------------------------
  # ðŸ”¹ Deux bases de donnÃ©es MySQL (master-master)
  # ----------------------------
  mysql1:
    image: mysql:8.0
    container_name: mysql1
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: clustering
      MYSQL_REPLICATION_USER: repl
      MYSQL_REPLICATION_PASSWORD: replpass
    volumes:
      - ./mysql/mysql1/my.cnf:/etc/mysql/conf.d/my.cnf
      - ./mysql/mysql1/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - private_net

  mysql2:
    image: mysql:8.0
    container_name: mysql2
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: clustering
      MYSQL_REPLICATION_USER: repl
      MYSQL_REPLICATION_PASSWORD: replpass
    volumes:
      - ./mysql/mysql2/my.cnf:/etc/mysql/conf.d/my.cnf
      - ./mysql/mysql2/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - private_net

  mysql3:
    image: mysql:8.0
    container_name: mysql3
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: clustering
      MYSQL_REPLICATION_USER: repl
      MYSQL_REPLICATION_PASSWORD: replpass
    volumes:
      - ./mysql/mysql3/my.cnf:/etc/mysql/conf.d/my.cnf
      - ./mysql/mysql3/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - private_net

  # -----------------------------------------------------
  # ðŸ”¹ Service dâ€™initialisation automatique de la rÃ©plication
  # -----------------------------------------------------
  replication-init:
    image: mysql:8.0
    container_name: replication-init
    depends_on:
      - mysql1
      - mysql2
    networks:
      - private_net
    volumes:
      - ./scripts:/scripts
    entrypoint: ["/bin/sh", "/scripts/setup-replication.sh"]


networks:
  public_net:
  private_net:
