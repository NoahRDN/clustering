services:
  # ----------------------------
  # ðŸ”¹ Service HTTP pour la configuration partagÃ©e
  # ----------------------------
  config-service:
    image: nginx:1.27
    platform: linux/amd64
    container_name: config-service
    ports:
      - "${CONFIG_SERVICE_PORT:-8088}:80"
    volumes:
      - ./shared-config:/usr/share/nginx/html:ro
    networks:
      - private_net
      - public_net

  # ----------------------------
  # ðŸ”¹ HAProxy pour les serveurs Web
  # ----------------------------
  haproxy-web:
    image: haproxy:2.9
    platform: linux/amd64
    container_name: haproxy-web
    ports:
      - "8080:8080"
      - "8404:8404"
    volumes:
      - ./haproxy-web/runtime:/var/run/haproxy
      - ./haproxy-web/haproxy-entrypoint.sh:/docker-entrypoint-custom.sh:ro
    depends_on:
      - config-service
      - web1
      - web2
    networks:
      - public_net
      - private_net
    extra_hosts:
      - "pc3-web2=${WEB2_REMOTE_IP:-172.20.10.4}"
    environment:
      HAPROXY_CONFIG_URL: ${HAPROXY_WEB_CONFIG_URL:-http://config-service/haproxy-web.cfg}
    command: ["/bin/bash", "/docker-entrypoint-custom.sh"]

  # ----------------------------
  # ðŸ”¹ HAProxy pour la base de donnÃ©es
  # ----------------------------
  haproxy-db:
    image: haproxy:2.9
    platform: linux/amd64
    container_name: haproxy-db
    ports:
      - "3307:3307"
      - "8405:8405"
    volumes:
      - ./haproxy-db/runtime:/var/run/haproxy
      - ./haproxy-db/haproxy-entrypoint.sh:/docker-entrypoint-custom.sh:ro
    depends_on:
      - config-service
      - mysql1
      - mysql2
    networks:
      - private_net
    extra_hosts:
      - "pc2-mysql1=${MYSQL1_REMOTE_IP:-172.20.10.2}"
    environment:
      HAPROXY_CONFIG_URL: ${HAPROXY_DB_CONFIG_URL:-http://config-service/haproxy-db.cfg}
    command: ["/bin/bash", "/docker-entrypoint-custom.sh"]

  runtime-api-web:
    build: ./runtime-api
    platform: linux/amd64
    container_name: runtime-api-web
    depends_on:
      - haproxy-web
    environment:
      ADMIN_SOCKET: /haproxy/admin.sock
      RELOAD_FLAG: /haproxy/reload.flag
      API_TOKEN: ${WEB_RUNTIME_API_TOKEN:-}
    volumes:
      - ./haproxy-web/runtime:/haproxy
    ports:
      - "${RUNTIME_API_WEB_PORT:-9101}:8000"
    networks:
      - private_net
      - public_net

  runtime-api-db:
    build: ./runtime-api
    platform: linux/amd64
    container_name: runtime-api-db
    depends_on:
      - haproxy-db
    environment:
      ADMIN_SOCKET: /haproxy/admin.sock
      RELOAD_FLAG: /haproxy/reload.flag
      API_TOKEN: ${DB_RUNTIME_API_TOKEN:-}
    volumes:
      - ./haproxy-db/runtime:/haproxy
    ports:
      - "${RUNTIME_API_DB_PORT:-9002}:8000"
    networks:
      - private_net

  # ----------------------------
  # ðŸ”¹ Serveurs web (PHP + Apache)
  # ----------------------------
  web1:
    image: php:8.2-apache
    platform: linux/amd64
    container_name: web1
    volumes:
      - ./web/web1:/var/www/html
    environment:
      DB_PROXY_HOST: ${DB_PROXY_HOST:-haproxy-db}
      DB_PROXY_PORT: ${DB_PROXY_PORT:-3307}
    depends_on:
      - haproxy-db
    networks:
      - private_net
    command: >
      bash -c "docker-php-ext-install pdo pdo_mysql && apache2-foreground"

  web2:
    image: php:8.2-apache
    platform: linux/amd64
    container_name: web2
    volumes:
      - ./web/web2:/var/www/html
    ports:
      - "${WEB2_PUBLISHED_PORT:-8082}:80"
    environment:
      DB_PROXY_HOST: ${DB_PROXY_HOST:-haproxy-db}
      DB_PROXY_PORT: ${DB_PROXY_PORT:-3307}
    depends_on:
      - haproxy-db
    networks:
      - private_net
    command: >
      bash -c "docker-php-ext-install pdo pdo_mysql && apache2-foreground"

  web-dashboard:
    image: php:8.2-apache
    platform: linux/amd64
    container_name: web-dashboard
    ports:
      - "8090:80"
    volumes:
      - ./web/web-dashboard:/var/www/html
      - ./haproxy-web:/data/haproxy-web
      - ./haproxy-db:/data/haproxy-db
      - ./haproxy-web/runtime:/haproxy-runtime
      - ./haproxy-db/runtime:/haproxy-db-runtime
      - ./shared-config:/data/shared-config
    environment:
      WEB_RUNTIME_API_URL: ${WEB_RUNTIME_API_URL:-}
      WEB_RUNTIME_API_TOKEN: ${WEB_RUNTIME_API_TOKEN:-}
      DB_RUNTIME_API_URL: ${DB_RUNTIME_API_URL:-}
      DB_RUNTIME_API_TOKEN: ${DB_RUNTIME_API_TOKEN:-}
    networks:
      - private_net
      - public_net
    command: >
      bash -c "docker-php-ext-install pdo pdo_mysql && apache2-foreground"

  web3:
    image: php:8.2-apache
    platform: linux/amd64
    container_name: web3
    volumes:
      - ./web/web3:/var/www/html
    environment:
      DB_PROXY_HOST: ${DB_PROXY_HOST:-haproxy-db}
      DB_PROXY_PORT: ${DB_PROXY_PORT:-3307}
    depends_on:
      - haproxy-db
    networks:
      - private_net
    command: >
      bash -c "docker-php-ext-install pdo pdo_mysql && apache2-foreground"

  # ----------------------------
  # ðŸ”¹ Bases de donnÃ©es MySQL (master-master)
  # ----------------------------
  mysql1:
    image: mysql:8.0
    platform: linux/amd64
    container_name: mysql1
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: clustering
      MYSQL_REPLICATION_USER: repl
      MYSQL_REPLICATION_PASSWORD: replpass
    volumes:
      - ./mysql/mysql1/my.cnf:/etc/mysql/conf.d/my.cnf
      - ./mysql/mysql1/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "${MYSQL1_PUBLISHED_PORT:-33061}:3306"
    networks:
      - private_net

  mysql2:
    image: mysql:8.0
    platform: linux/amd64
    container_name: mysql2
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: clustering
      MYSQL_REPLICATION_USER: repl
      MYSQL_REPLICATION_PASSWORD: replpass
    volumes:
      - ./mysql/mysql2/my.cnf:/etc/mysql/conf.d/my.cnf
      - ./mysql/mysql2/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - private_net

  mysql3:
    image: mysql:8.0
    platform: linux/amd64
    container_name: mysql3
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: clustering
      MYSQL_REPLICATION_USER: repl
      MYSQL_REPLICATION_PASSWORD: replpass
    volumes:
      - ./mysql/mysql3/my.cnf:/etc/mysql/conf.d/my.cnf
      - ./mysql/mysql3/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - private_net

  # ----------------------------
  # ðŸ”¹ Service dâ€™initialisation de la rÃ©plication
  # ----------------------------
  replication-init:
    image: mysql:8.0
    platform: linux/amd64
    container_name: replication-init
    depends_on:
      - mysql1
      - mysql2
    networks:
      - private_net
    volumes:
      - ./scripts:/scripts
    extra_hosts:
      - "pc2-mysql1=${MYSQL1_REMOTE_IP:-172.20.10.2}"
    environment:
      MYSQL1_HOST: ${MYSQL1_HOST:-mysql1}
      MYSQL1_PORT: ${MYSQL1_PORT:-3306}
      MYSQL2_HOST: ${MYSQL2_HOST:-mysql2}
      MYSQL2_PORT: ${MYSQL2_PORT:-3306}
    entrypoint: ["/bin/sh", "/scripts/setup-replication.sh"]

networks:
  public_net:
  private_net:
