# ---------------------------
# partie pour configurer HAProxy en tant que load balancer HTTP
# ---------------------------
global
    # Journalisation dans la sortie standard (utile en Docker)
    log stdout format raw local0
    user haproxy
    group haproxy
    stats socket ipv4@0.0.0.0:9999 level admin
# ---------------------------
# PARAMÈTRES PAR DÉFAUT
# ---------------------------
defaults
    log global
    mode http                 # HAProxy travaille ici en mode HTTP (non TCP)
    option httplog            # Active un format de log optimisé pour HTTP
    option http-server-close  # Ferme la connexion après chaque requête
    timeout connect 5000      # Timeout de connexion au serveur backend (5s)
    timeout client  50000     # Timeout côté client (50s)
    timeout server  50000     # Timeout côté serveur (50s)

# ---------------------------
# FRONTEND - Point d'entrée
# ---------------------------
frontend http_front
    bind *:8080               # Écoute sur le port 8080 (accessible via http://localhost:8080)
    default_backend web_back  # Redirige tout le trafic vers le backend nommé "web_back"

# ---------------------------
# BACKEND - Serveurs Web
# ---------------------------
backend web_back
    balance roundrobin                 # Répartition équilibrée : web1 -> web2 -> web1 -> ...
    
    # Persistance de session (sticky session)
    # HAProxy ajoute un cookie SRV pour identifier le serveur qui gère la session.
    # Exemple : Set-Cookie: SRV=S1 -> le navigateur renverra toujours SRV=S1 ensuite.
    
    cookie SRV insert indirect nocache
    option httpchk                     # Vérifie régulièrement que les serveurs répondent bien
    
    # Définition des serveurs applicatifs
    # "check" = envoie des requêtes de santé automatiques
    # "cookie S1/S2" = identifiant de serveur pour la persistance de session
    server web1 web1:80 cookie S1 check
    server web2 web2:80 cookie S2 check

# ---------------------------
# PAGE DE STATISTIQUES
# ---------------------------
listen stats
    bind *:8404               # Accessible via http://localhost:8404/stats
    stats enable              # Active la page de monitoring intégrée
    stats uri /stats          # L’URL pour y accéder
    stats refresh 10s         # Actualisation automatique toutes les 10 secondes

# ---------------------------
# RAPPEL VISUEL DU FLUX
# ---------------------------
# [Client HTTP]
#      ↓
# [HAProxy - port 8080]
#      ↓
# [Backend web_back]
#     ↙           ↘
#  web1:80 (S1)   web2:80 (S2)
#      ↑
#  (cookie SRV=S1 → session persistante)
