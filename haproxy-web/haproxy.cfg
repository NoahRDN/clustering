# ---------------------------
# partie pour configurer HAProxy en tant que load balancer HTTP
# ---------------------------
global
    # Journalisation dans la sortie standard (utile en Docker)
    log stdout format raw local0

# ---------------------------
# PARAMÃˆTRES PAR DÃ‰FAUT
# ---------------------------
defaults
    mode http                 # HAProxy travaille ici en mode HTTP (non TCP)
    option httplog            # Active un format de log optimisÃ© pour HTTP
    option http-server-close  # Ferme la connexion aprÃ¨s chaque requÃªte
    timeout connect 5000      # Timeout de connexion au serveur backend (5s)
    timeout client  50000     # Timeout cÃ´tÃ© client (50s)
    timeout server  50000     # Timeout cÃ´tÃ© serveur (50s)

# ---------------------------
# ðŸ”¹ FRONTEND - Point d'entrÃ©e
# ---------------------------
frontend http_front
    bind *:8080               # Ã‰coute sur le port 8080 (accessible via http://localhost:8080)
    default_backend web_back  # Redirige tout le trafic vers le backend nommÃ© "web_back"

# ---------------------------
# ðŸ”¹ BACKEND - Serveurs Web
# ---------------------------
backend web_back
    balance roundrobin                 # RÃ©partition Ã©quilibrÃ©e : web1 -> web2 -> web1 -> ...
    
    # Persistance de session (sticky session)
    # HAProxy ajoute un cookie SRV pour identifier le serveur qui gÃ¨re la session.
    # Exemple : Set-Cookie: SRV=S1 -> le navigateur renverra toujours SRV=S1 ensuite.
    cookie SRV insert indirect nocache
    
    option httpchk                     # VÃ©rifie rÃ©guliÃ¨rement que les serveurs rÃ©pondent bien
    
    # DÃ©finition des serveurs applicatifs
    # "check" = envoie des requÃªtes de santÃ© automatiques
    # "cookie S1/S2" = identifiant de serveur pour la persistance de session
    server web1 web1:80 cookie S1 check
    server web2 web2:80 cookie S2 check

# ---------------------------
# ðŸ”¹ PAGE DE STATISTIQUES
# ---------------------------
listen stats
    bind *:8404               # Accessible via http://localhost:8404/stats
    stats enable              # Active la page de monitoring intÃ©grÃ©e
    stats uri /stats          # Lâ€™URL pour y accÃ©der
    stats refresh 10s         # Actualisation automatique toutes les 10 secondes

# ---------------------------
# ðŸ”¹ RAPPEL VISUEL DU FLUX
# ---------------------------
# [Client HTTP]
#      â†“
# [HAProxy - port 8080]
#      â†“
# [Backend web_back]
#     â†™           â†˜
#  web1:80 (S1)   web2:80 (S2)
#      â†‘
#  (cookie SRV=S1 â†’ session persistante)
