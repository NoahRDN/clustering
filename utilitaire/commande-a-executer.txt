docker compose down --remove-orphans
docker rm -f mysql1 mysql2 haproxy-db 2>$null
docker network prune -f

docker compose up -d
docker ps

docker exec -it mysql1 mysql -u root -proot -e "SHOW MASTER STATUS;"
docker exec -it mysql2 mysql -u root -proot -e "SHOW MASTER STATUS;"

docker exec -it mysql1 bash -lc "chmod 644 /etc/mysql/conf.d/my.cnf"
docker exec -it mysql2 bash -lc "chmod 644 /etc/mysql/conf.d/my.cnf"

# Sur mysql1
docker exec -it mysql1 mysql -u root -proot -e "
DROP USER IF EXISTS 'repl'@'%';
CREATE USER 'repl'@'%' IDENTIFIED WITH mysql_native_password BY 'replpass';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;"

# Sur mysql2
docker exec -it mysql2 mysql -u root -proot -e "
DROP USER IF EXISTS 'repl'@'%';
CREATE USER 'repl'@'%' IDENTIFIED WITH mysql_native_password BY 'replpass';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;"

docker exec -it mysql1 mysql -u root -proot -e "
ALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY 'root';
FLUSH PRIVILEGES;"

docker exec -it mysql2 mysql -u root -proot -e "
ALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY 'root';
FLUSH PRIVILEGES;"

# mysql1 réplique depuis mysql2
docker exec -it mysql1 mysql -u root -proot -e "
STOP SLAVE;
CHANGE MASTER TO 
  MASTER_HOST='mysql2',
  MASTER_USER='repl',
  MASTER_PASSWORD='replpass',
  MASTER_AUTO_POSITION=1;
START SLAVE;"

# mysql2 réplique depuis mysql1
docker exec -it mysql2 mysql -u root -proot -e "
STOP SLAVE;
CHANGE MASTER TO 
  MASTER_HOST='mysql1',
  MASTER_USER='repl',
  MASTER_PASSWORD='replpass',
  MASTER_AUTO_POSITION=1;
START SLAVE;"

docker exec -it mysql1 mysql -u root -proot -e "SHOW SLAVE STATUS\G"
docker exec -it mysql2 mysql -u root -proot -e "SHOW SLAVE STATUS\G"


# Insère depuis mysql1
docker exec -it mysql1 mysql -u root -proot -e "
USE clustering;
INSERT INTO test_sync (msg) VALUES ('OK depuis MySQL1 ✅');"

# Vérifie dans mysql2
docker exec -it mysql2 mysql -u root -proot -e "
USE clustering;
SELECT * FROM test_sync;"
 
mysql -h 127.0.0.1 -P 3307 -u root -proot -e "
USE clustering;
SELECT * FROM test_sync;"

docker stop mysql1
mysql -h 127.0.0.1 -P 3307 -u root -proot -e "SHOW DATABASES;"
docker start mysql1

# Insère depuis mysql2
docker exec -it mysql2 mysql -u root -proot -e "
USE clustering;
INSERT INTO test_sync (msg) VALUES ('OK depuis MySQL2 ✅');"

# Vérifie dans mysql1
docker exec -it mysql1 mysql -u root -proot -e "
USE clustering;
SELECT * FROM test_sync;"

# Vérifie dans mysql2
docker exec -it mysql2 mysql -u root -proot -e "
USE clustering;
SELECT * FROM test_sync;"

mysql -h 127.0.0.1 -P 3307 -u root -proot -e "
USE clustering;
SELECT * FROM test_sync;"

